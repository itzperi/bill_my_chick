# 🔧 Step-by-Step Salary Table Fix

## 🚨 **The Error You're Getting**
`ERROR: 42P01: relation "public.salaries" does not exist`

This means the table doesn't exist at all in your database.

## 📋 **Step-by-Step Solution**

### **Step 1: Try the Basic Table Creation First**

**Copy and paste this SIMPLE SQL into your Supabase SQL Editor:**

```sql
-- BASIC SALARY TABLE CREATION
-- Just create the basic table
CREATE TABLE public.salaries (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    business_id text NOT NULL,
    salary_date date NOT NULL,
    amount numeric(10,2) NOT NULL,
    employee_id text,
    notes text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

-- Add basic constraint
ALTER TABLE public.salaries 
ADD CONSTRAINT salaries_business_id_not_empty 
CHECK (length(trim(business_id)) > 0);

-- Enable RLS
ALTER TABLE public.salaries ENABLE ROW LEVEL SECURITY;

-- Create basic policies
CREATE POLICY salaries_select_policy ON public.salaries FOR SELECT USING (true);
CREATE POLICY salaries_insert_policy ON public.salaries FOR INSERT WITH CHECK (true);
CREATE POLICY salaries_update_policy ON public.salaries FOR UPDATE USING (true);
CREATE POLICY salaries_delete_policy ON public.salaries FOR DELETE USING (true);

-- Grant permissions
GRANT ALL ON public.salaries TO anon;
GRANT ALL ON public.salaries TO authenticated;

-- Test insert
INSERT INTO public.salaries (business_id, salary_date, amount, employee_id, notes) 
VALUES ('santhosh1', CURRENT_DATE, 1000.00, 'TEST', 'Test entry');

-- Verify
SELECT 'BASIC SALARIES TABLE CREATED' as status;
SELECT COUNT(*) as total_salaries FROM public.salaries;
```

### **Step 2: If Step 1 Works, Add the Function**

**Run this additional SQL:**

```sql
-- Create the safe_add_salary function
CREATE OR REPLACE FUNCTION public.safe_add_salary(
    p_business_id text,
    p_salary_date date,
    p_amount numeric,
    p_employee_id text DEFAULT NULL,
    p_notes text DEFAULT NULL
) RETURNS bigint
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_salary_id bigint;
BEGIN
    -- Validate inputs
    IF p_business_id IS NULL OR trim(p_business_id) = '' THEN
        RAISE EXCEPTION 'Business ID is required';
    END IF;
    
    IF p_salary_date IS NULL THEN
        RAISE EXCEPTION 'Salary date is required';
    END IF;
    
    IF p_amount IS NULL OR p_amount <= 0 THEN
        RAISE EXCEPTION 'Salary amount must be greater than 0';
    END IF;
    
    -- Insert salary entry
    INSERT INTO public.salaries (business_id, salary_date, amount, employee_id, notes)
    VALUES (p_business_id, p_salary_date, p_amount, p_employee_id, p_notes)
    RETURNING id INTO v_salary_id;
    
    RETURN v_salary_id;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Failed to add salary: %', SQLERRM;
END;
$$;

-- Test the function
SELECT public.safe_add_salary(
    'santhosh1',
    CURRENT_DATE,
    2000.00,
    'TEST_FUNC',
    'Function test'
) as test_salary_id;
```

### **Step 3: Test Your Salary Page**

1. Go to your Salary page
2. Try to add a salary entry
3. It should work without the "table not found" error

## 🔍 **Troubleshooting**

### **If you still get errors:**

1. **Check Supabase Dashboard**:
   - Go to your Supabase project
   - Click on "Table Editor" in the left sidebar
   - Look for the `salaries` table
   - If it's not there, the SQL didn't run properly

2. **Check the SQL Editor**:
   - Make sure you're running the SQL in the correct project
   - Check if there are any error messages in the SQL editor

3. **Try a different approach**:
   - Go to Supabase Dashboard → Table Editor
   - Click "New Table"
   - Create a table named `salaries` manually
   - Add the columns: id, business_id, salary_date, amount, employee_id, notes, created_at, updated_at

## ✅ **Expected Result**

After running the SQL:
- The `salaries` table should exist in your database
- Your Salary page should work without errors
- You should be able to save salary entries

## 🚨 **If Nothing Works**

If you're still having issues, try this alternative approach:

1. **Create the table manually in Supabase Dashboard**:
   - Go to Table Editor
   - Click "New Table"
   - Name: `salaries`
   - Add columns manually

2. **Or contact Supabase support**:
   - There might be a permission issue with your database

The key is to get the basic table created first, then add the function later.
